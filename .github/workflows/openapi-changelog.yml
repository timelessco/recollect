jobs:
  changelog:
    name: API Changelog
    permissions:
      contents: write
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683 # v4
        with:
          fetch-depth: 2

      - id: guard
        name: Guard — check previous commit exists
        run: |
          if ! git rev-parse HEAD~1 >/dev/null 2>&1; then
            echo "No previous commit — skipping changelog generation"
            echo "skip=true" >> "$GITHUB_OUTPUT"
          fi

      - if: steps.guard.outputs.skip != 'true'
        name: Install dependencies
        uses: ./.github/actions/pnpm-install

      - if: steps.guard.outputs.skip != 'true'
        name: Generate spec from current commit
        run: |
          mkdir -p .oasdiff
          npx tsx scripts/generate-openapi.ts
          cp public/openapi.json .oasdiff/openapi-new.json

      - if: steps.guard.outputs.skip != 'true'
        name: Generate spec from previous commit
        run: |
          git worktree add /tmp/prev-commit HEAD~1
          if [ ! -f /tmp/prev-commit/scripts/generate-openapi.ts ]; then
            echo '{"openapi":"3.0.3","info":{"title":"Recollect API","version":"0.0.0"},"paths":{}}' > .oasdiff/openapi-old.json
          else
            cd /tmp/prev-commit
            if pnpm install --frozen-lockfile --prefer-offline && npx tsx scripts/generate-openapi.ts; then
              cp public/openapi.json "$GITHUB_WORKSPACE/.oasdiff/openapi-old.json"
            else
              echo "Prev-commit generation failed — falling back to empty spec"
              echo '{"openapi":"3.0.3","info":{"title":"Recollect API","version":"0.0.0"},"paths":{}}' > "$GITHUB_WORKSPACE/.oasdiff/openapi-old.json"
            fi
            cd -
          fi
          git worktree remove /tmp/prev-commit --force 2>/dev/null || true

      - if: steps.guard.outputs.skip != 'true'
        name: Install oasdiff
        run: |
          go install github.com/oasdiff/oasdiff@latest
          echo "$(go env GOPATH)/bin" >> "$GITHUB_PATH"

      - if: steps.guard.outputs.skip != 'true'
        name: Generate API changelog
        run: |
          oasdiff changelog .oasdiff/openapi-old.json .oasdiff/openapi-new.json \
            --format markdown > .oasdiff/changelog-entry.md || true
      - if: steps.guard.outputs.skip != 'true'
        name: Append changelog entry
        run: |
          if [ -s .oasdiff/changelog-entry.md ]; then
            # Strip auto-generated heading and demote ## to ### (nest under date heading)
            sed -i '1{/^# API Changelog/d}' .oasdiff/changelog-entry.md
            sed -i 's/^## /### /' .oasdiff/changelog-entry.md
            # Skip if only whitespace remains after stripping heading
            if ! grep -q '[^[:space:]]' .oasdiff/changelog-entry.md; then
              echo "No API changes detected — skipping changelog update"
              exit 0
            fi
            DATE=$(date -u +"%Y-%m-%d")
            SHORT_SHA="${{ github.sha }}"
            SHORT_SHA="${SHORT_SHA:0:7}"
            REPO="${{ github.repository }}"
            {
              echo ""
              echo "## ${DATE} [\`${SHORT_SHA}\`](https://github.com/${REPO}/commit/${{ github.sha }})"
              echo ""
              cat .oasdiff/changelog-entry.md
            } >> docs/API_CHANGELOG.md
          else
            echo "No API changes detected — skipping changelog update"
          fi

      - if: steps.guard.outputs.skip != 'true'
        name: Commit changelog
        uses: stefanzweifel/git-auto-commit-action@04702edda442b2e678b25b537cec683a1493fcb9 # v7
        with:
          commit_message: "docs(api): update API changelog [skip ci]"
          file_pattern: docs/API_CHANGELOG.md
    timeout-minutes: 15

name: OpenAPI Changelog

on:
  push:
    branches:
      - dev
