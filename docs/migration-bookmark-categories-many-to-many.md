# Migration: Many-to-Many Bookmark-Category Relationship

## Overview

**Goal:** Allow a single bookmark to belong to multiple categories (many-to-many relationship).

**Current state:** One-to-one relationship via `category_id` column in `everything` table.

**Target state:** Junction table `bookmark_categories` linking bookmarks to multiple categories.

---

## Database Migration

### Why Junction Table Over Array Column?

| Feature                 | Junction Table   | Array Column (`bigint[]`) |
| ----------------------- | ---------------- | ------------------------- |
| Foreign key constraints | Yes              | No                        |
| ON DELETE CASCADE       | Yes              | No (manual cleanup)       |
| Query performance       | Standard indexes | GIN index, slower         |
| Data integrity          | Enforced by DB   | Application-level         |

**Recommendation:** Junction table for data integrity and automatic cleanup.

### Migration SQL

```sql
-- 1. Create junction table
CREATE TABLE IF NOT EXISTS public.bookmark_categories (
    id bigint GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    bookmark_id bigint NOT NULL,
    category_id bigint NOT NULL,
    created_at timestamp with time zone DEFAULT timezone('utc', now()) NOT NULL,
    CONSTRAINT bookmark_categories_bookmark_id_fkey
        FOREIGN KEY (bookmark_id) REFERENCES public.everything(id) ON DELETE CASCADE,
    CONSTRAINT bookmark_categories_category_id_fkey
        FOREIGN KEY (category_id) REFERENCES public.categories(id) ON DELETE CASCADE,
    CONSTRAINT bookmark_categories_unique UNIQUE (bookmark_id, category_id)
);

-- 2. Migrate existing data
INSERT INTO public.bookmark_categories (bookmark_id, category_id)
SELECT id, category_id FROM public.everything
WHERE category_id IS NOT NULL;

-- 3. Drop old constraints
ALTER TABLE public.everything DROP CONSTRAINT IF EXISTS everything_category_id_fkey;
DROP INDEX IF EXISTS public.everything_unique_url_category_id;

-- 4. Drop old column
ALTER TABLE public.everything DROP COLUMN category_id;

-- 5. Create indexes for performance
CREATE INDEX idx_bookmark_categories_bookmark_id ON public.bookmark_categories(bookmark_id);
CREATE INDEX idx_bookmark_categories_category_id ON public.bookmark_categories(category_id);

-- 6. Enable RLS
ALTER TABLE public.bookmark_categories ENABLE ROW LEVEL SECURITY;

-- 7. RLS policies (adjust based on your security model)
CREATE POLICY "Users can view their bookmark categories" ON public.bookmark_categories
    FOR SELECT USING (
        bookmark_id IN (SELECT id FROM public.everything WHERE user_id = auth.uid())
    );

CREATE POLICY "Users can insert their bookmark categories" ON public.bookmark_categories
    FOR INSERT WITH CHECK (
        bookmark_id IN (SELECT id FROM public.everything WHERE user_id = auth.uid())
    );

CREATE POLICY "Users can delete their bookmark categories" ON public.bookmark_categories
    FOR DELETE USING (
        bookmark_id IN (SELECT id FROM public.everything WHERE user_id = auth.uid())
    );
```

---

## Codebase Changes Required

### HIGH Priority (Core Logic)

#### 1. Types - Single Bookmark Data Structure

**File:** `src/types/apiTypes.ts`

- **Lines 31-46:** `SingleListData` type
- **Change:** `category_id: number | null` → fetch from junction table or return array

**File:** `src/types/database-generated.types.ts`

- **Lines 98-159:** `everything` table definition
- **Change:** Remove `category_id` field, add `bookmark_categories` table types
- **Lines 48-58:** `BookmarksCountTypes` - rework counting logic

---

#### 2. API Route: Add Category to Bookmark

**File:** `src/pages/api/category/add-category-to-bookmark.ts`

- **Lines 47-66:** Core update logic
- **Current:**

  ```typescript
  .update({ category_id: categoryId })
  .match({ id: bookmarkId })
  ```

- **Change:** INSERT into `bookmark_categories` junction table instead of UPDATE

---

#### 3. API Route: Add Bookmark Min Data

**File:** `src/pages/api/bookmark/add-bookmark-min-data.ts`

- **Lines 223-232:** Category assignment during creation
- **Lines 259-302:** Duplicate bookmark check (currently checks same URL in same category)
- **Lines 346:** `category_id: computedCategoryId`
- **Change:**
  - Insert bookmark first, then INSERT into junction table
  - Remove duplicate URL check per category (user wants no constraint)

---

#### 4. API Route: Fetch Bookmarks Data

**File:** `src/pages/api/bookmark/fetch-bookmarks-data.ts`

- **Lines 163-208:** Filters by `category_id`
- **Change:** JOIN with `bookmark_categories` table:

  ```sql
  SELECT * FROM everything e
  JOIN bookmark_categories bc ON e.id = bc.bookmark_id
  WHERE bc.category_id = $1
  ```

---

#### 5. API Route: Search Bookmarks

**File:** `src/pages/api/bookmark/search-bookmarks.ts`

- **Lines 91-96:** `.eq("category_id", category_id)`
- **Change:** Use subquery or JOIN with junction table

---

#### 6. Mutation: Add Category to Bookmark (Optimistic)

**File:** `src/async/mutationHooks/category/useAddCategoryToBookmarkOptimisticMutation.ts`

- **Lines 31-91:** Optimistic update logic
- **Change:** Complete rewrite - handle adding/removing from array instead of single value

---

#### 7. Mutation: Add Bookmark Min Data (Optimistic)

**File:** `src/async/mutationHooks/bookmarks/useAddBookmarkMinDataOptimisticMutation.ts`

- **Lines 72-78:** Sets `category_id` during creation
- **Change:** Adjust optimistic data structure for junction table approach

---

#### 8. Component: AddToCollectionDropdown

**File:** `src/components/lightbox/AddToCollectionDropdown.tsx`

- **Lines 103-105:** Gets single `category_id` from bookmark
- **Lines 108-114:** Finds current collection (single)
- **Lines 137-194:** Handles collection selection
- **Change:** Convert to multi-select checkbox interface, track array of category IDs

---

#### 9. Component: Add Modal Content

**File:** `src/pageComponents/dashboard/modals/addModalContent.tsx`

- **Lines 82-102:** Builds category options (single select)
- **Lines 104-115:** Gets bookmark's current category (single)
- **Change:** Convert to multi-select with checkboxes

---

#### 10. Helper Functions

**File:** `src/async/supabaseCrudHelpers/index.ts`

- **Lines 245-271:** `addBookmarkMinData()` - update to handle junction table
- **Lines 527-546:** `addCategoryToBookmark()` - INSERT into junction instead of UPDATE
- **Lines 335-373:** `searchBookmarks()` - adjust category filtering
- **Lines 879-883:** `sanitizeBookmarks()` - import logic for multiple categories

---

### MEDIUM Priority (Query/Hook Updates)

#### 11. Hook: Delete Collection

**File:** `src/hooks/useDeleteCollection.ts`

- **Lines 33-35:** Checks if category has bookmarks
- **Change:** Query `bookmark_categories` table instead of `everything.category_id`

---

#### 12. Hook: Fetch Paginated Bookmarks

**File:** `src/async/queryHooks/bookmarks/useFetchPaginatedBookmarks.ts`

- **Lines 24, 35:** Uses `category_id` in query key
- **Change:** Query key structure may need adjustment for multi-category support

---

#### 13. Hook: Search Bookmarks

**File:** `src/async/queryHooks/bookmarks/useSearchBookmarks.ts`

- **Lines 36, 49:** Uses `category_id` for filtering
- **Change:** Adjust to filter via junction table

---

#### 14. Mutation: Add Category to Bookmark (Non-optimistic)

**File:** `src/async/mutationHooks/category/useAddCategoryToBookmarkMutation.ts`

- **Lines 14-36:** Non-optimistic mutation
- **Change:** Update to INSERT into junction table

---

#### 15. API Route: Fetch Bookmarks View

**File:** `src/pages/api/bookmark/fetch-bookmarks-view.ts`

- **Lines 26-38:** Fetches view settings by category
- **Change:** Minimal - queries `categories` table directly, not affected

---

### LOW Priority (Minimal/No Changes)

#### 16. Hook: Get Current Category ID

**File:** `src/hooks/useGetCurrentCategoryId.ts`

- **Lines 28-29:** Gets category from URL slug
- **Change:** None - this gets viewing context, not bookmark relationship

---

#### 17. Hook: Fetch Categories

**File:** `src/async/queryHooks/category/useFetchCategories.ts`

- **Lines 8-30:** Fetches user categories
- **Change:** None - independent of bookmark-category relationship

---

#### 18. Mutation: Add Category (Optimistic)

**File:** `src/async/mutationHooks/category/useAddCategoryOptimisticMutation.ts`

- **Lines 17-76:** Creates new category
- **Change:** None - creates categories, not relationships

---

#### 19. Component: Collections List

**File:** `src/pageComponents/dashboard/sidePane/collectionsList.tsx`

- **Lines 37-49:** Uses mutations
- **Change:** Depends on backend changes, UI likely stays same

---

#### 20. Store: Component Store

**File:** `src/store/componentStore.ts`

- **Lines 35-65:** Loading states
- **Change:** May need multiple loading states for bulk operations

---

## Summary Table

| Priority     | Files | Key Changes                                |
| ------------ | ----- | ------------------------------------------ |
| **CRITICAL** | 1     | Database migration SQL                     |
| **HIGH**     | 10    | API routes, mutations, components, helpers |
| **MEDIUM**   | 5     | Hooks, query adjustments                   |
| **LOW**      | 5     | Minimal or no changes                      |

**Total files requiring changes:** ~15-20

---

## Key Behaviors After Migration

1. **Bookmarks must have at least 1 category** - default to uncategorized (id=0)
2. **Same URL can exist multiple times** - no uniqueness constraint
3. **Deleting a category** - removes it from bookmarks via CASCADE, bookmark persists
4. **UI change** - dropdowns become multi-select checkboxes

---

## Foreign Key Enforcement Explained

A foreign key ensures values in one table **must exist** in another table.

**Example:**

```sql
bookmark_categories.category_id → categories.id
```

If category 5 is deleted:

- `ON DELETE CASCADE` automatically removes all rows where `category_id = 5`
- Bookmarks remain but lose that category association
- No orphaned references or "ghost" categories

Without FK (array column):

- Deleting category leaves `[3, 5, 7]` in bookmark
- Category 5 is orphaned - causes errors displaying category name
- Requires manual application-level cleanup
