### Import Raindrop Bookmarks (Success - Mixed Categories)
# Imports 4 bookmarks: 2 Unsorted, 2 "unread" category
# Expected: { "data": { "queued": 4, "skipped": 0 }, "error": null }
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://oscargabriel.dev/blog/tanstacks-open-ai-sdk",
      "title": "TanStack's Open. AI. SDK.",
      "description": "TanStack AI takes the headless, vendor-agnostic philosophy that made TanStack famous and applies it to AI development. Here's how it compares to Vercel's AI SDK.",
      "ogImage": "https://oscargabriel.dev/images/lilo-and-stitch.jpg",
      "category_name": "Unsorted",
      "inserted_at": "2025-12-07T18:22:14.710Z"
    },
    {
      "url": "https://v0.app/chat/react-view-transitions-u0iKm2LIxil?utm_source=sahaj-jj&utm_medium=referral&utm_campaign=share_chat&ref=35O8TY",
      "title": "React view transitions - v0 by Vercel",
      "description": "use view transitions in react to demoswitching between alternate layouts (list \u2194 grid \u2194 masonry)",
      "ogImage": "https://v0.app/chat/api/og/u0iKm2LIxil",
      "category_name": "Unsorted",
      "inserted_at": "2025-11-16T09:25:32.574Z"
    },
    {
      "url": "https://www.animate-code.com",
      "title": "Beautiful code animations - AnimateCode",
      "description": "AnimateCode lets you create stunning keynote-inspired transitions for your code.",
      "ogImage": "https://animate-code.com/thumbnail.png",
      "category_name": "unread",
      "inserted_at": "2025-04-10T17:10:54.000Z"
    },
    {
      "url": "https://magicui.design/docs/components/icon-cloud",
      "title": "Interactive Icon Cloud",
      "description": "An interactive 3D tag cloud component",
      "ogImage": "https://magicui.design/og?title=Icon%20Cloud&description=An%20interactive%203D%20tag%20cloud%20component",
      "category_name": "unread",
      "inserted_at": "2025-03-18T17:04:43.000Z"
    }
  ]
}

### Import Single Bookmark (Unsorted)
# Expected: { "data": { "queued": 1, "skipped": 0 }, "error": null }
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://oscargabriel.dev/blog/tanstacks-open-ai-sdk",
      "title": "TanStack's Open. AI. SDK.",
      "description": "TanStack AI takes the headless, vendor-agnostic philosophy that made TanStack famous and applies it to AI development.",
      "ogImage": "https://oscargabriel.dev/images/lilo-and-stitch.jpg",
      "category_name": "Unsorted",
      "inserted_at": "2025-12-07T18:22:14.710Z"
    }
  ]
}

### Dedup Test - Re-import Same URL
# Run after importing single bookmark above
# Expected: { "data": { "queued": 0, "skipped": 1 }, "error": null }
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://oscargabriel.dev/blog/tanstacks-open-ai-sdk",
      "title": "TanStack's Open. AI. SDK.",
      "description": "Different description but same URL",
      "ogImage": null,
      "category_name": "unread",
      "inserted_at": "2025-12-07T18:22:14.710Z"
    }
  ]
}

### Batch Dedup - Duplicate URLs Within Same Batch
# In-memory dedup removes the second entry before hitting DB
# Expected: { "data": { "queued": 1, "skipped": 1 }, "error": null }
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://example.com/unique-url-dedup-test",
      "title": "First Copy",
      "description": "This one should be imported",
      "ogImage": null,
      "category_name": "Unsorted",
      "inserted_at": "2025-01-01T00:00:00.000Z"
    },
    {
      "url": "https://example.com/unique-url-dedup-test",
      "title": "Second Copy",
      "description": "This one should be skipped (in-memory dedup)",
      "ogImage": null,
      "category_name": "Unsorted",
      "inserted_at": "2025-01-01T00:00:00.000Z"
    }
  ]
}

### Validation Error - Empty Bookmarks
# Expected: 400 - At least one bookmark required
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": []
}

### Auth Error - No Token
# Expected: 401 Unauthorized
POST {{$dotenv API_BASE_URL}}/raindrop/import
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://example.com",
      "title": "No Auth Test",
      "description": null,
      "ogImage": null,
      "category_name": null,
      "inserted_at": null
    }
  ]
}

### Validation Error - Invalid URL Format
# Expected: 400 - Invalid url
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "not-a-valid-url",
      "title": "Invalid URL Test",
      "description": null,
      "ogImage": null,
      "category_name": null,
      "inserted_at": null
    }
  ]
}

### Validation Error - Missing URL
# Expected: 400 - url is required
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "title": "Missing URL Test",
      "description": null,
      "ogImage": null,
      "category_name": null,
      "inserted_at": null
    }
  ]
}


###############################################################################
# FULL FLOW TEST: Import → Status → Worker → Retry
#
# Prerequisites:
# 1. Start Edge Function: npx supabase functions serve process-raindrop-imports --no-verify-jwt
# 2. Run tests in order below
###############################################################################

### Flow Step 1: Import Bookmarks
# Expected: { "data": { "queued": 2, "skipped": 0 }, "error": null }
POST {{$dotenv API_BASE_URL}}/raindrop/import
Authorization: Bearer {{$dotenv USER_TOKEN}}
Content-Type: application/json

{
  "bookmarks": [
    {
      "url": "https://www.animate-code.com",
      "title": "Beautiful code animations - AnimateCode",
      "description": "AnimateCode lets you create stunning keynote-inspired transitions for your code.",
      "ogImage": "https://animate-code.com/thumbnail.png",
      "category_name": "unread",
      "inserted_at": "2025-04-10T17:10:54.000Z"
    },
    {
      "url": "https://magicui.design/docs/components/icon-cloud",
      "title": "Interactive Icon Cloud",
      "description": "An interactive 3D tag cloud component",
      "ogImage": "https://magicui.design/og?title=Icon%20Cloud&description=An%20interactive%203D%20tag%20cloud%20component",
      "category_name": "unread",
      "inserted_at": "2025-03-18T17:04:43.000Z"
    }
  ]
}

### Flow Step 2: Check Status (should show pending messages)
# Expected: { "data": { "pending": 2, "archived": 0, "archives": [] }, "error": null }
GET {{$dotenv API_BASE_URL}}/raindrop/import/status
Authorization: Bearer {{$dotenv USER_TOKEN}}

### Flow Step 3: Invoke Worker (processes queue)
# Expected: { "processed": N, "archived": N, ... }
POST {{$dotenv FUNCTIONS_BASE_URL}}/process-raindrop-imports
Authorization: Bearer {{$dotenv SERVICE_ROLE_KEY}}
Content-Type: application/json

{}

### Flow Step 4: Check Status After Processing
# Expected: { "data": { "pending": 0, ... }, "error": null }
GET {{$dotenv API_BASE_URL}}/raindrop/import/status
Authorization: Bearer {{$dotenv USER_TOKEN}}
